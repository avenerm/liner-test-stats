---
title: "Liner Testing Stats Visualization"
output:
  html_document:
    df_print: paged
---


```{r setup}
# Import packages
library(tidyverse)
library(knitr)
library(bit)
library(scales)
library(ggeasy)

# Suppress warnings
opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

# Round values in tables to 2 digits
kable <- function(data, caption = "") {
  knitr::kable(data, digits = 3, caption = caption)
}

# Function to read date from Excel
date_from_char <- function(char_date) {
  date <- as.Date(char_date, "%m/%d/%Y")
}

# Function to read percent from Excel
prop_from_percent <- function(char_percent) {
  prop <- as.numeric(gsub("%", "", char_percent))/100
}
```



```{r prep}


# Read file and select relevant data
systems <- read_csv("Liner Test Tracking & Projections.csv", col_names = TRUE, skip = 5) %>%
  select(sys_id = 3, contractor = 15, sys_depth = 17, sys_area = 18, 
         date_1 = 21, depth_1 = 25, filled_1 = 23, rr_1 = 24,
         date_2 = 27, depth_2 = 28, filled_2 = 29, rr_2 = 30,
         date_3 = 33, depth_3 = 34, filled_3 = 35, rr_3 = 36,
         date_4 = 39, depth_4 = 40, filled_4 = 41, rr_4 = 42,
         date_5 = 45, depth_5 = 46, filled_5 = 47, rr_5 = 48,
         date_6 = 51, depth_6 = 52, filled_6 = 53, rr_6 = 54,
         date_7 = 57, depth_7 = 58, filled_7 = 59, rr_7 = 60,
         date_8 = 63, depth_8 = 64, filled_8 = 65, rr_8 = 66,
         date_9 = 69, depth_9 = 70, filled_9 = 71, rr_9 = 72,
         status = 75, tests_to_pass = 76)

# Remove systems that haven't been tested
systems <- systems %>%
  filter(date_1 != "") 

# Clean up data and change types as needed
systems <- systems %>% 
  mutate(across(contains("date"), date_from_char)) %>%
  mutate(across(contains("filled"), prop_from_percent)) %>%
  mutate(
    contractor = toupper(contractor),
    sys_depth = as.numeric(sys_depth),
    sys_area = as.numeric(gsub(",", "", sys_area)),
    tests_to_pass = factor(as.numeric(tests_to_pass), levels = seq(1, max(as.numeric(tests_to_pass), na.rm=TRUE))),
    first_test_date = date_1,
    last_test_date = pmax(date_1, date_2, date_3, date_4, date_5, date_6, date_7, date_8, date_9, na.rm = TRUE)
  )

# Create tests dataframe with one row per test and remove rows without test data
tests <- pivot_longer(systems,
  cols = 5:28,
  names_to = c(".value","test_num"),
  names_sep = "_",) %>% 
  select(-tests_to_pass, -first_test_date) %>%
  filter(!is.na(date))

# Remove "status" col and add "result" col indicating whether test passed. Add FY 
tests <- tests %>%
  group_by(sys_id) %>%
    mutate(
      result = lag(status, n=length(status)-1, default="Fail"),
      FY = ifelse(month(date)>6, year(date)+1, year(date))) %>%
    select(-status)

# Remove test data from systems dataframe
systems <- systems %>%
  select(-contains("date_")) %>%
  select(-contains("depth_")) %>%
  select(-contains("filled_")) %>%
  select(-contains("rr_")) %>%
  relocate(first_test_date, .after = sys_id) %>%
  relocate(last_test_date, .after = first_test_date)  

```


```{r tests_by_year}
kable(
  tests %>%
    group_by("Fiscal Year" = FY) %>%
    summarize("No. of Tests" = n(), "No. of Systems" = n_distinct(sys_id)),
  caption = "Liner Performance Tests by Fiscal Year"
)
```


```{r tests_by_year_chart}
tests_by_year_df <-   
  tests %>%
    group_by(FY) %>%
    summarize("No. of Tests" = n(), "No. of Systems" = n_distinct(sys_id)) %>%
    gather("Stat", "Value", -FY)


ggplot(tests_by_year_df, aes(x = FY, y = Value, fill = Stat)) + 
  geom_col(position = "dodge") + 
  geom_text(aes(x=FY, Value, label = Value),
            vjust = -.5, color = "black", position = position_dodge(0.9)) + 
  scale_y_continuous(breaks = seq(from = 0, to = 150, by = 25), minor_breaks = 25, limits = c(0,150)) +
  scale_x_discrete(limits = seq(min(year(tests$date)), max(year(tests$date)))) + 
  labs(title = "Liner Performance Tests by Fiscal Year", x = "Fiscal Year", y = "", fill = "") + 
  ggeasy::easy_center_title() + 
  theme(text = element_text(size= 14), legend.position = "bottom") 

```


```{r tests_to_pass}

#All years
all_sys_passed <- filter(systems, !is.na(tests_to_pass)) %>%
  group_by("Number of Tests" = tests_to_pass, .drop = FALSE) %>%
  summarize(
    "Number of Systems" = n(), 
    "Percentage of Total" = percent(n()/nrow(filter(systems, !is.na(tests_to_pass))), accuracy = 0.1))
kable(all_sys_passed, caption = "Number of Tests to Pass: All Years")


#FY23 Only
sys_fy23_passed <- filter(systems, !is.na(tests_to_pass) & year(first_test_date) == 2023) %>%
  group_by("Number of Tests" = tests_to_pass, .drop = FALSE) %>%
  summarize(
    "Number of Systems" = n(), 
    "Percentage of Total" = percent(n()/nrow(.), accuracy = 0.1)
  )
kable(sys_fy23_passed, caption = "Number of Tests to Pass: FY23 Only")

#FY24 Only
sys_fy24_passed <- filter(systems, !is.na(tests_to_pass) & year(first_test_date) == 2024) %>%
  group_by("Number of Tests" = tests_to_pass, .drop = FALSE) %>%
  summarize(
    "Number of Systems" = n(), 
    "Percentage of Total" = percent(n()/nrow(.), accuracy = 0.1)
  )
kable(sys_fy24_passed, caption = "Number of Tests to Pass: FY24 Only")

#FY25 Only
sys_fy25_passed <- filter(systems, !is.na(tests_to_pass) & year(first_test_date) == 2025) %>%
  group_by("Number of Tests" = tests_to_pass, .drop = FALSE) %>%
  summarize(
    "Number of Systems" = n(), 
    "Percentage of Total" = percent(n()/nrow(.), accuracy = 0.1)
  )
kable(sys_fy25_passed, caption = "Number of Tests to Pass: FY25 Only")
```

```{r tests_to_pass_by_year}
ave_tests_to_pass_by_yr <-  systems %>%
  group_by("Fiscal Year of First Test" = 
             ifelse(month(first_test_date)>6, year(first_test_date)+1, year(first_test_date))) %>%
  summarize("Number of Systems Passed" = n(), 
            "Average Number of Tests to Pass" = mean(tests_to_pass, na.rm = TRUE))
kable(ave_tests_to_pass_by_yr, caption = "Average Number of Tests to Pass by Fiscal Year")
```

```{r tests_to_pass_by_contractor}
ave_tests_to_pass_by_contractor <- filter(systems, !is.na(tests_to_pass)) %>%
    group_by("Contractor" = contractor) %>%
    summarize("Total Systems Passed" = n(), "Average Tests to Pass" = mean(tests_to_pass)) %>%
    arrange(select(.,3))
kable(ave_tests_to_pass_by_contractor, caption = "Average Number of Tests to Pass by Contractor")
```

```{r}
med_rr_by_yr <- tests %>%
group_by("Fiscal Year" = FY) %>%
summarize("Median of Max Recession Rate" = median(rr, na.rm = TRUE))
kable(med_rr_by_yr, caption = "Median of Max Recession Rate by Year")
```

```{r}
fy_starts <- seq(from = date_from_char("7/1/2020"), by = "year", length.out = 5)
ggplot(data = tests, mapping = aes(x = date, y = rr, color = result)) + 
  geom_point() + 
  scale_y_continuous(breaks = seq(from = 0, to = 16, by = 2), limits = c(0, 16)) +
  stat_smooth(method = "lm", formula = y~x, se=FALSE, linetype = "dashed", color = "black") + 
  annotate("text", x = date_from_char("5/1/2020"), y = 4.4, label = "Linear Fit", angle = -4) + 
  geom_hline(yintercept = 1, linetype = "dashed") + 
  annotate("text", x = date_from_char("2/15/2020"), y = 0.6, label = "1 in/hr Limit") + 
  scale_x_date(breaks = fy_starts,
               date_minor_breaks = "3 months",
               limits = c(date_from_char("1/1/2020"), date_from_char("4/1/2025"))
  ) +
  labs(title = "Timeseries of Max Recession Rates", x = "Date", y = "Maximum Recession Rate (in/hr)") + 
  theme(legend.position = "bottom", plot.title = element_text(size = 12), legend.title=element_blank()) + 
  ggeasy::easy_center_title()
```


```{r}

ggplot(data = tests, mapping = aes(x = date, y = filled, color = result)) + 
  geom_point() + 
  scale_y_continuous(breaks = seq(0, 1.5, by=0.25), limits = c(0,max(max(tests$filled), 1.5)), 
                     labels = percent) +
  stat_smooth(method = "lm", formula = y~x, se=FALSE, linetype = "dashed", color = "black") + 
  annotate("text", x = date_from_char("2/15/2021"), y = 0.835, label = "Linear Fit", angle = 3) + 
  geom_hline(yintercept = 1, linetype = "dashed") + 
  annotate("text", x = date_from_char("5/1/2020"), y = 1.06, label = "1 in/hr Limit") + 
  scale_x_date(breaks = fy_starts,
               date_minor_breaks = "3 months",
               limits = c(date_from_char("1/1/2020"), date_from_char("4/1/2025"))
  ) +
  labs(title = "Timeseries of Percent Storage Depth Filled", x = "Date", y = "Percent Filled") + 
  theme(legend.position = "bottom", plot.title = element_text(size = 12), legend.title=element_blank()) + 
  ggeasy::easy_center_title()
```